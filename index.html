<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Minhas Dívidas</title>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<style>
*{
    margin:0;
    padding:0;
    box-sizing:border-box;
    font-family:'Segoe UI',system-ui,sans-serif
}

/* FUNDO */
body{
    min-height:100vh;
    background:radial-gradient(
        circle at top left,
        #e5e7eb 0%,
        #f1f5f9 40%,
        #ffffff 100%
    );
    overflow-y:auto;
}

/* LOGIN */
.hidden{display:none}
.login-box{
    max-width:360px;
    margin:80px auto;
    background:#fff;
    border-radius:30px;
    padding:24px;
    box-shadow:0 35px 90px rgba(0,0,0,.2)
}
.login-box input,.login-box button{
    width:100%;
    padding:12px;
    border-radius:16px;
    margin-bottom:10px
}
.login-box button{
    border:none;
    background:#1f2933;
    color:#fff;
    font-weight:600
}
.link{
    text-align:center;
    color:#1f2933;
    font-size:13px;
    cursor:pointer
}

/* APP */
.app{
    max-width:420px;
    margin:20px auto;
    background:#fff;
    border-radius:30px;
    padding:22px;
    box-shadow:0 35px 90px rgba(0,0,0,.2);
    max-height:90vh;
    overflow-y:auto;
}
.header{text-align:center}

/* TOTAL */
.total-card{
    background:linear-gradient(135deg,#1f2933,#374151);
    color:#fff;
    border-radius:26px;
    padding:22px;
    margin:18px 0;
    text-align:center
}

/* NAV */
.nav{
    display:flex;
    gap:8px;
    margin-bottom:16px
}
.nav button{
    flex:1;
    padding:12px;
    border-radius:16px;
    border:none;
    background:#e5e7eb;
    font-weight:600;
    color:#111827
}
.nav button.active{
    background:#1f2933;
    color:#fff
}

/* FORM */
input,select{
    width:100%;
    padding:12px;
    border-radius:16px;
    border:1px solid #d1d5db;
    margin-bottom:12px
}
.btn-primary{
    background:#1f2933;
    color:#fff;
    border:none;
    border-radius:16px;
    padding:12px;
    font-weight:600
}

/* PAGES */
.page{display:none}
.page.active{display:block}

/* LISTAS */
.mes-card,.item{
    background:#f3f4f6;
    border-radius:20px;
    padding:14px;
    margin-bottom:10px
}
.badge{
    background:#e5e7eb;
    color:#111827;
    padding:4px 12px;
    border-radius:20px;
    font-size:11px
}
.remover{
    margin-top:8px;
    background:#b91c1c;
    color:#fff;
    border:none;
    border-radius:14px;
    padding:8px
}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="login-box" id="loginBox">
    <input id="email" placeholder="Email">
    <input id="senha" type="password" placeholder="Senha">
    <button onclick="entrar()">Entrar</button>
    <button onclick="registrar()">Criar conta</button>
    <div class="link" onclick="recuperar()">Esqueci minha senha</div>
</div>

<!-- APP -->
<div id="app" class="hidden">
<div class="app">

<div class="header">
    <h1>Minhas Dívidas</h1>
    <p>Seu controle financeiro, mês a mês</p>
</div>

<div class="total-card">
    <span>Total geral das dívidas</span><br>
    <strong id="totalGeral">R$ 0,00</strong>
</div>

<div class="nav">
    <button id="btnAdd" class="active" onclick="trocar('add')">Adicionar</button>
    <button id="btnList" onclick="trocar('list')">Dívidas</button>
    <button id="btnCat" onclick="trocar('cat')">Categorias</button>
</div>

<div class="page active" id="add">
    <input id="nome" placeholder="Nome da dívida">
    <input id="valor" type="number" placeholder="Valor (R$)">
    <select id="categoria">
        <option value="">Categoria</option>
        <option>Cartão de Crédito</option>
        <option>Lazer</option>
        <option>Empréstimo</option>
        <option>Investimento</option>
        <option>Conta fixa</option>
        <option>Outros</option>
    </select>
    <input type="month" id="mes">
    <button class="btn-primary" onclick="adicionar()">Adicionar dívida</button>
    <button class="btn-primary" onclick="sair()">Sair</button>
</div>

<div class="page" id="list"></div>
<div class="page" id="mesDetalhe"></div>
<div class="page" id="cat"></div>

</div>
</div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyCGBxI9RA5tsGpBQiYwfsMRNaoo9Cm_TDo",
  authDomain: "controle-dividas-1bff0.firebaseapp.com",
  projectId: "controle-dividas-1bff0"
});

const auth = firebase.auth();
const db = firebase.firestore();

let userId=null, unsubscribe=null, dividas=[];

auth.onAuthStateChanged(user=>{
    loginBox.classList.toggle("hidden",!!user);
    app.classList.toggle("hidden",!user);
    if(user){ userId=user.uid; ouvirDividas(); }
    else if(unsubscribe) unsubscribe();
});

function entrar(){ auth.signInWithEmailAndPassword(email.value,senha.value).catch(e=>alert(e.message)); }
function registrar(){ auth.createUserWithEmailAndPassword(email.value,senha.value).catch(e=>alert(e.message)); }
function recuperar(){ if(!email.value)return alert("Informe o email"); auth.sendPasswordResetEmail(email.value).then(()=>alert("Email enviado")); }
function sair(){ auth.signOut(); }

function ouvirDividas(){
    unsubscribe=db.collection("usuarios").doc(userId).collection("dividas")
    .orderBy("criadoEm","asc")
    .onSnapshot(s=>{
        dividas=[];
        s.forEach(d=>dividas.push({id:d.id,...d.data()}));
        localStorage.setItem("backup_dividas_"+userId,JSON.stringify(dividas));
        renderTotal();
        if(btnList.classList.contains("active"))renderMeses();
        if(btnCat.classList.contains("active"))renderCategorias();
    });
}

function trocar(p){
    document.querySelectorAll(".page").forEach(e=>e.classList.remove("active"));
    document.querySelectorAll(".nav button").forEach(b=>b.classList.remove("active"));
    document.getElementById(p).classList.add("active");
    if(p==="add")btnAdd.classList.add("active");
    if(p==="list"){btnList.classList.add("active");renderMeses();}
    if(p==="cat"){btnCat.classList.add("active");renderCategorias();}
}

function adicionar(){
    if(!nome.value||!valor.value||!categoria.value||!mes.value)
        return alert("Preencha todos os campos!");
    db.collection("usuarios").doc(userId).collection("dividas").add({
        nome:nome.value,
        valor:Number(valor.value),
        categoria:categoria.value,
        mes:mes.value,
        criadoEm:firebase.firestore.FieldValue.serverTimestamp()
    });
    nome.value=valor.value=categoria.value=mes.value="";
}

function renderTotal(){
    totalGeral.innerText="R$ "+dividas.reduce((s,d)=>s+d.valor,0).toFixed(2);
}

function renderMeses(){
    list.innerHTML="";
    [...new Set(dividas.map(d=>d.mes))].forEach(m=>{
        const t=dividas.filter(d=>d.mes===m).reduce((s,d)=>s+d.valor,0);
        const c=document.createElement("div");
        c.className="mes-card";
        c.innerHTML=`<strong>${m}</strong><br>R$ ${t.toFixed(2)}`;
        c.onclick=()=>abrirMes(m);
        list.appendChild(c);
    });
}

function abrirMes(m){
    mesDetalhe.innerHTML=`<button onclick="trocar('list')">← Voltar</button>`;
    dividas.filter(d=>d.mes===m).forEach(d=>{
        const i=document.createElement("div");
        i.className="item";
        i.innerHTML=`
            <strong>${d.nome}</strong><br>
            <span class="badge">${d.categoria}</span><br>
            R$ ${d.valor.toFixed(2)}
            <button class="remover" onclick="remover('${d.id}')">Remover</button>`;
        mesDetalhe.appendChild(i);
    });
    trocar("mesDetalhe");
}

function remover(id){
    db.collection("usuarios").doc(userId).collection("dividas").doc(id).delete();
}

function renderCategorias(){
    cat.innerHTML="";
    const c={};
    dividas.forEach(d=>c[d.categoria]=(c[d.categoria]||0)+d.valor);
    for(let k in c){
        const card=document.createElement("div");
        card.className="mes-card";
        card.innerHTML=`<strong>${k}</strong><br>R$ ${c[k].toFixed(2)}`;
        cat.appendChild(card);
    }
}
</script>

</body>
</html>
